<!-- Do NOT open the html file on local, or else it won't work since it will be blocked by CORS policy-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Neighborhood Explorer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>   
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #1c1e26;
    color: #f1f3f5;
    margin: 0;
    padding: 0;
    line-height: 1.6;
  }

  header {
    padding: 20px;
    background-color: #1c1e26;
  }

  h1 {
    font-size: 2rem;
    margin-left: 1%;
    margin: 0;
    padding: 10px 20px;
  }

  nav#bar {
    background-color: #2a2d38;
    padding: 0 5px;
    display: flex;
    justify-content: flex-start;
    gap: 5px;
    align-items: center;
    height: 60px;
    border-bottom: 0px solid #444857;
    margin-bottom: 1%;
  }

  nav a {
    color: #f1f3f5;
    text-decoration: none;
    position: relative;
    font-size: 1rem;
    padding: 10px 0;
    transition: color 0.3s ease;
    margin-left: 1%;
  }

  nav a::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 6px;
    width: 100%;
    height: 2px;
    background-color: #4a90e2;
    transform: scaleX(0);
    transition: transform 0.3s ease;
    transform-origin: right;
  }

  nav a:hover::after,
  nav #selectedPage::after {
    transform: scaleX(1);
    transform-origin: left;
  }

  nav #selectedPage {
    font-weight: bold;
    color: #8ab4f8;
  }

  main {
    display: flex;
    flex-direction: row;
    padding: 20px;
    gap: 30px;
    max-width: 1600px;
    margin: 0 auto;
  }

  #map {
    flex: 2;
    height: 650px;
    width: 50%;
    margin-left: 1%;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    margin-bottom: 2%;
  }

  .side-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 30px;
  }

  label#text-select-topic {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5%;
    margin-left: 1%;

  }

  select#topic-select {
    background-color: #2a2d38;
    color: #f1f3f5;
    padding: 10px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid #444857;
    width: 25%;
    transition: border 0.3s, box-shadow 0.3s;
    margin-left: 1%;
    margin-bottom: 0.5%;
  }

  select#topic-select:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3);
    outline: none;
  }

  #kpi.kpi {
    background-color: #2a2d38;
    padding: 20px;
    border-radius: 10px;
    border-left: 6px solid #4a90e2;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  #kpi h3 {
    margin-top: 0;
    font-size: 1.3rem;
    color: #f1f3f5;
  }

  #kpi p {
    margin: 8px 0;
    color: #adb5bd;
  }

  footer {
    text-align: center;
    padding: 20px;
    font-size: 0.9rem;
    color: #6c757d;
    border-top: 1px solid #2a2d38;
  }
</style>
</head>
<body>
  <h1>Neighborhood Explorer - Sant Cugat del Vallès</h1>
  <nav id="bar">
    <a id='selectedPage' href="explorer.html">Explorer</a>
    <a id='df' href="">Compare</a>
    <a id='fd' href="">Correlation</a>
    <a id='navBar' href="downloads.html">Downloads</a>
  </nav>

  <label id='text-select-topic' for="topic-select">Select a topic</label>
  <select id="topic-select">
    <optgroup label="Demographics">
      <option value="1">Population (total)</option>
      <option value="2">Elderly Population (65yrs old and above) (%)</option>
      <option value="3">Foreign Population (%)</option>
      <option value="4">Children Population (15yrs old and below) (%)</option>
      <option value="5">Age (average)</option>
    </optgroup>
    <optgroup label="Education">
      <option value="6">Population with Higher Education (15yrs old and above) (%)</option>
    </optgroup>
    <optgroup label="Employment">
      <option value="7">Employment (16yrs old and above) (%)</option>
    </optgroup>
    <optgroup label="Households">
      <option value="8">Households, Owned (%)</option>
      <option value="9">Households, Rented (%)</option>
      <option value="10">Households, Size (average)</option>
      <option value="11">Households, living alone (%)</option>
      <option value="12">Households, 2 members (%)</option>
      <option value="13">Households, 3 members (%)</option>
      <option value="14">Households, 4 members (%)</option>
      <option value="15">Households, 5 and more members (%)</option>
      <option value="16">Households, elder (75yrs old and above) living alone (%)</option>
      <option value="17">Households, all members elders (65yrs old and above) (%)</option>  
    </optgroup>

  
  </select>

  <div id="map">
      <script>

        let map = null;

        var updateMap = function (topic){
          
          if(map) map.remove();
          map = L.map('map',{zoomSnap: 0.1}).setView([41.467, 2.075], 12.6);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'}).addTo(map);
        
          var fetchDDBB = function(columnNumber) {
            var buildClasses = function(rows,columnNumber){
              var valueList = []
              var nameList = []
              for(let i=1;i<rows.length-1;i++){
                valueList.push(parseFloat(rows[i][columnNumber]))
                nameList.push(rows[i][1])
              }

              let minV = parseFloat(Math.min(...valueList))
              let maxV = parseFloat(Math.max(...valueList))
              let classRange = parseFloat((maxV - minV)/5)
              var classList = []
              for(let j=0;j<valueList.length;j++){
                if(valueList[j]<(minV+classRange)){
                  classList.push(['0'+rows[j+1][0],1]);
                } else if(valueList[j]>=(minV+classRange) && valueList[j]<(minV+2*classRange)){
                  classList.push(['0'+rows[j+1][0],2]);
                } else if(valueList[j]>=(minV+2*classRange) && valueList[j]<(minV+3*classRange)){
                  classList.push(['0'+rows[j+1][0],3]);
                } else if(valueList[j]>=(minV+3*classRange) && valueList[j]<(minV+4*classRange)){
                  classList.push(['0'+rows[j+1][0],4]);
                } else {
                  classList.push(['0'+rows[j+1][0],5]);
                }
              }
              return [valueList, nameList, classList];       
            }

            return fetch('../data/ddbb.csv')
              .then(response => response.text())
              .then(csvText => {
                var rows = csvText.split('\n').map(row => row.split(','));
                var cList = buildClasses(rows,columnNumber);
                return cList;
              }); 

          }
          
          var fetchGEOJSON = function(classList,map){
            fetch('../data/shapes.geojson')
              .then(response => response.json())
              .then(data => {
                L.geoJSON(data, {
                  style: function(feature){
                    return {
                      fillColor: colorFunction(feature,classList[2]),
                      color: 'black',
                      stroke: true,
                      weight: 1,
                      fillOpacity: 0.7
                    };
                  },
                  onEachFeature: function(feature, layer) {
                    const contentCode = feature.properties.MUNDISSEC;
                    
                    let contentValue;
                    for(let k=0;k<classList[0].length;k++){
                      if(contentCode==classList[2][k][0]){
                        contentValue = classList[1][k]+": "+parseFloat(classList[0][k]);
                        break;
                      }
                    }
                    layer.on('click', function(e) {
                    layer.bindPopup(contentValue).openPopup();
                    });
                  }
                }).addTo(map);
              })
              .catch(err => console.error('Error loading GeoJSON:', err));
          }
          
          var colorFunction = function(feature, classList){
            for(let k=0;k<classList.length;k++){
              if(feature.properties.MUNDISSEC==classList[k][0]){
                switch (classList[k][1]){
                  case 1:
                    return '#8fb3df';
                    break;
                  case 2:
                    return '#6086b6';
                    break;
                  case 3:
                    return '#3f6490';
                    break;
                  case 4:
                    return '#214167';
                    break;
                  case 5:
                    return '#0e2542';
                }
              }
            }
            
          }

          fetchDDBB(topic).then(classList => {
            fetchGEOJSON(classList, map);
          });
        }

        updateMap(2);
    
        const topicSelect = document.getElementById('topic-select');
        const mapElement = document.getElementById('map');
        const populationElement = document.getElementById('population');
        const incomeElement = document.getElementById('average-income');
        const navig = document.getElementById('navBar');

        
        topicSelect.addEventListener('change', () => {
          const topic = parseInt(topicSelect.value)+1;
          updateMap(topic);
        });

          </script>
  </div>

  <div id="kpi" class="kpi">
    <h3>KPIs for Selected Neighborhood</h3>
    <p>Population: <span id="population"></span></p>
    <p>Average Income: <span id="average-income"></span></p>
  </div>

  <script>
    

  </script>
</body>
<footer>
    <p>Author: Eric Gutiérrez</p>
</footer>
</html>
