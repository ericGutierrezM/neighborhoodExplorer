<!-- Do NOT open the html file on local, or else it won't work since it will be blocked by CORS policy-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Neighborhood Explorer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>   
 <style>
    body {
      font-family: Verdana, sans-serif;
      color: aliceblue;
      background-color: #7faf89;
      margin: 20px;
    }

    .kpi {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      background-color: #423e2f;
    }
    nav {
      margin-bottom: 20px;
      font-size: 20px;
    }
    a {
      text-decoration: none;
      color: aliceblue;
    }
    #bar {
        background-color: #423e2f;
    }
    #text-select-topic {
        font-size: 18px;
    }
    #map {
        width: 50%;
        height:700px;
        margin-top:20px;
    }
    #selectedPage {
      color: #90EE90;
    }
  </style>
</head>
<body>
  <h1>Neighborhood Explorer - Sant Cugat del Vallès</h1>
  <nav id="bar">
    <a id='selectedPage' href="index.html">Explorer</a>
    <a id='navBar' href="downloads.html">Downloads</a>
  </nav>

  <label id='text-select-topic' for="topic-select">Select a topic</label>
  <select id="topic-select">
    <option value="topic1">Population (total)</option>
    <option value="topic2">Elderly Population</option>
    <option value="topic3">Unemployment</option>
  </select>

  <div id="map">
      <script>
  
        
        const map = L.map('map',{zoomSnap: 0.1}).setView([41.467, 2.075], 12.7);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);
        

        var fetchDDBB = function() {
          var buildClasses = function(rows,columnNumber){
            var valueList = []
            for(let i=1;i<rows.length-1;i++){
              valueList.push(parseInt(rows[i][columnNumber]))
            }
            let minV = Math.min(...valueList)
            let maxV = Math.max(...valueList)
            let classRange = (maxV - minV)/5
            var classList = []
            for(let j=0;j<valueList.length;j++){
              if(valueList[j]<(minV+classRange)){
                classList.push(['0'+rows[j+1][0],1]);
              } else if(valueList[j]>=(minV+classRange) && valueList[j]<(minV+2*classRange)){
                classList.push(['0'+rows[j+1][0],2]);
              } else if(valueList[j]>=(minV+2*classRange) && valueList[j]<(minV+3*classRange)){
                classList.push(['0'+rows[j+1][0],3]);
              } else if(valueList[j]>=(minV+3*classRange) && valueList[j]<(minV+4*classRange)){
                classList.push(['0'+rows[j+1][0],4]);
              } else {
                classList.push(['0'+rows[j+1][0],5]);
              }
            }
            return classList;       
          }

          return fetch('../data/ddbb.csv')
            .then(response => response.text())
            .then(csvText => {
              var rows = csvText.split('\n').map(row => row.split(','));
              var cList = buildClasses(rows,1);
              return cList;
            }); 

        }
        
        var fetchGEOJSON = function(classList,map){
          console.log(classList)
          fetch('../data/shapes.geojson')
            .then(response => response.json())
            .then(data => {
              L.geoJSON(data, {
                style: function(feature){
                  return {
                    color: colorFunction(feature,classList),
                    stroke: 0,
                    fillOpacity: 0.9
                  };
                },
              }).addTo(map);
            })
            .catch(err => console.error('Error loading GeoJSON:', err));
        }
        
        var colorFunction = function(feature, classList){
          for(let k=0;k<classList.length;k++){
            if(feature.properties.MUNDISSEC==classList[k][0]){
              switch (classList[k][1]){
                case 1:
                  return '#8fb3df';
                  break;
                case 2:
                  return '#6086b6';
                  break;
                case 3:
                  return '#3f6490';
                  break;
                case 4:
                  return '#214167';
                  break;
                case 5:
                  return '#0e2542';
              }
            }
          }
          
        }
        
        var buildStroke = function(map){
          fetch('../data/shapes.geojson')
            .then(response => response.json())
            .then(data => {
              L.geoJSON(data, {
                style: function(feature){
                  return {
                    color: 'black',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0
                  };
                },
              }).addTo(map);
            })
            .catch(err => console.error('Error loading GeoJSON:', err));
        }

        fetchDDBB().then(classList => {
          fetchGEOJSON(classList, map);
          buildStroke(map);
        });
        
        

      </script>
  </div>

  <div id="kpi" class="kpi">
    <h3>KPIs for Selected Neighborhood</h3>
    <p>Population: <span id="population"></span></p>
    <p>Average Income: <span id="average-income"></span></p>
  </div>

  <script>
    const topicSelect = document.getElementById('topic-select');
    const mapElement = document.getElementById('map');
    const populationElement = document.getElementById('population');
    const incomeElement = document.getElementById('average-income');
    const navig = document.getElementById('navBar')

    navig.addEventListener('mouseover', () => {
        navig.style.color = 'lightgreen'
    })
    navig.addEventListener('mouseout', () => {
        navig.style.color='aliceblue'
    })
    topicSelect.addEventListener('change', () => {
      const topic = topicSelect.value;
      updateMap(topic);
      updateKPIs(topic);
    });

    function updateMap(topic) {
      mapElement.innerHTML = `<img src="maps/${topic}.png" alt="${topic} Map" style="width:100%; height:100%;">`;
    }

    function updateKPIs(topic) {
      if (topic === 'neighborhood1') {
        populationElement.textContent = '100,000';
        incomeElement.textContent = '$50,000';
      } else if (neighborhood === 'neighborhood2') {
        populationElement.textContent = '80,000';
        incomeElement.textContent = '$55,000';
      } else if (neighborhood === 'neighborhood3') {
        populationElement.textContent = '120,000';
        incomeElement.textContent = '$45,000';
      }
    }

    // Initialize with default
    updateMap(neighborhoodSelect.value);
    updateKPIs(neighborhoodSelect.value);
  </script>
</body>
<footer>
    <p>Author: Eric Gutiérrez</p>
</footer>
</html>
